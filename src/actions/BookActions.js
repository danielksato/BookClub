// @flow
import { createAction, type ActionCreator, type ThunkAction } from 'actions';
import {
	SEARCH_BOOK_SUCCESS,
	// DELETE_BOOK,
	// CONFIRM_BOOK,
} from 'constants/ActionConstants';
import {
	searchBook as searchBookApi,
	suggestBook as suggestBookApi,
	vote as voteApi,
	modifyBook as modifyBookApi,
} from 'apis/BookApi';
import { loadClubSuccess } from 'actions/ClubActions';
import { setGrowler } from 'actions/AppActions';

import type BookRecord from 'records/BookRecord';
import type { ClubRecord } from 'reducers/ClubReducer';
import type { ClubResponse } from 'apis/ClubApi';
import type { BookResponse } from 'apis/BookApi';

type SearchBookSuccessParam = Array<BookResponse>;
const _searchBookSuccess: ActionCreator<SearchBookSuccessParam> = createAction(SEARCH_BOOK_SUCCESS);

const handleBookError = (dispatch) => (err) => {
	/* eslint-disable no-console */
	console.error(err);
	/* eslint-enable no-console */
	dispatch(setGrowler(new Error('Book error')));
};

export const searchBook = (search: string): ThunkAction => {
	return (dispatch) => {
		searchBookApi({ search }).then((results: SearchBookSuccessParam) => {
			dispatch(_searchBookSuccess(results));
		}, handleBookError(dispatch));
	};
};

export const suggestBook = ({
	book,
	club,
}: {
	book: BookRecord,
	club: ClubRecord,
}): ThunkAction => {
	return function(dispatch) {
		suggestBookApi({ book, club }).then((club: ClubResponse) => {
			dispatch(loadClubSuccess(club));
		}, handleBookError(dispatch));
	};
};

export const vote = ({
	book,
	club,
	inFavor,
}: {
	book: BookRecord,
	club: ClubRecord,
	inFavor: boolean,
}): ThunkAction => {
	return function(dispatch) {
		voteApi({ book, club, inFavor }).then(
			(club) => dispatch(loadClubSuccess(club)),
			handleBookError(dispatch)
		);
	};
};

export const modifyBook = ({
	status,
	bookId,
	clubId,
}: {
	status: string,
	bookId: number,
	clubId: number,
}): ThunkAction => {
	return async function(dispatch) {
		modifyBookApi({ status, bookId, clubId }).then(
			(club) => dispatch(loadClubSuccess(club)),
			handleBookError(dispatch)
		);
	};
};
